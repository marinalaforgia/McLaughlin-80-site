{
    "contents" : "#Creating climate indices\nsetwd(\"/users/Marina/Documents/UCD/Research/Year 1/McLaughlin 80/Final Data\")\n#abio<-read.csv(\"weather_elise_withET.csv\")\nabio<-read.csv(\"precip_1985.csv\")\nlibrary(plyr)\n###NOTE: two precip outliers (>500mm per day) from feb 2003 and feb 2004 are removed from abio with following code\nabio[218,12]<-abio[218,12]-640.8\nabio[230,12]<-abio[230,12]-534.4\n#Precip Jan-Jun\n  clim.in<-ddply(abio, \"year\", summarize, precip.JJ = sum(precip[1:6]))\n\n#Precip August - July\n  janjul <-ddply(abio, \"year\", summarize, precip.JJ = sum(precip[1:7]))\n  augdec <-ddply(abio, \"year\", summarize, precip.AD = sum(precip[8:12]))\n  \n  #precip.yr = augdec$precip.AD[1:(15-1)] + janjul$precip.JJ[2:15]\n  precip.yr = augdec$precip.AD[1:(30-1)] + janjul$precip.JJ[2:30]\n  precip.yr = c(NA, precip.yr)\n\n  clim.in$precip.yr<-precip.yr\n  rm(janjul,augdec,precip.yr)\n\n#Precip in each season\n  ##Fall precip (Sep-Nov) of previous year\n  fall<-ddply(abio, \"year\", summarize, precip.fall = sum(precip[10:11]))\n  fall<-fall$precip.fall[1:(30-1)]  \n  fall<-c(NA, fall)\n\n  clim.in$precip.fall<-fall\n  rm(fall)\n  \n  ##Winter precip (Dec-Feb)\n  dec <-ddply(abio, \"year\", summarize, precip.dec = sum(precip[12]))\n  janfeb <-ddply(abio, \"year\", summarize, precip.jf = sum(precip[1:3]))\n\n  winter = dec$precip.dec[1:(30-1)] + janfeb$precip.jf[2:30]\n  winter = c(NA, winter)\n\n  clim.in$precip.win<-winter\n  rm(dec,winter,janfeb)\n  \n  ##Spring precip (Mar-May)\n  spring<-ddply(abio, \"year\", summarize, precip.spr = sum(precip[4:5]))\n  clim.in$precip.spr<-spring$precip.spr\n  rm(spring)\n\n  ##Summer precip (Jun-Aug)\n  summer<-ddply(abio, \"year\", summarize, precip.sum = sum(precip[6:9]))\n  clim.in$precip.sum<-summer$precip.sum\n\n#temp jan-jun\n  temp.JJ<-ddply(abio, \"year\", summarize, temp.JJ = mean(avg.temp[1:6]))\n  clim.in$temp.JJ<-temp.JJ$temp.JJ\n  rm(temp.JJ)\n\n#temp august-july\n    janjun <-ddply(abio, \"year\", summarize, temp.JJ = mean(avg.temp[1:7]))\n    augdec <-ddply(abio, \"year\", summarize, temp.AD = mean(avg.temp[8:12]))\n    \n    tempyear = augdec$temp.AD[1:(30-1)] + janjun$temp.JJ[2:30]\n    tempyear = c(NA, tempyear)   \n    \n    clim.in$temp.yr<-tempyear\n    rm(tempyear,janjun,augdec)\n\n#temp in each season\n  ##Fall temp (Sep-Nov) of previous year\n  fall.t<-ddply(abio, \"year\", summarize, temp.fall = mean(avg.temp[9:11]))\n  fall.t<-fall.t$temp.fall[1:(30-1)]  \n  fall.t = c(NA, fall.t)\n  \n  clim.in$temp.fall<-fall.t\n  rm(fall.t)\n\n  ##Winter temp (Dec-Feb)\n  dec.t <-ddply(abio, \"year\", summarize, temp.dec = mean(avg.temp[12]))\n  janfeb.t <-ddply(abio, \"year\", summarize, temp.jf = mean(avg.temp[1:2]))\n  \n  win.temp = dec.t$temp.dec[1:(30-1)] + janfeb.t$temp.jf[2:30]\n  win.temp = c(NA, win.temp)\n  \n  clim.in$temp.win<-win.temp\n  rm(win.temp,dec.t,janfeb.t)\n  \n##Spring temp (Mar-May)\n  spring<-ddply(abio, \"year\", summarize, temp.spr = mean(avg.temp[3:5]))\n  clim.in$temp.spr<-spring$temp.spr\n  rm(spring)\n  ##Summer temp (Jun-Aug)\n  summer<-ddply(abio, \"year\", summarize, temp.sum = mean(avg.temp[6:8]))\n  clim.in$temp.sum<-summer$temp.sum\n  rm(summer)\n\n#max temp\n    temp.max<-ddply(abio, \"year\", summarize, maxtemp = max(avg.daily.max))\n    climate$max.avg.max.temp<-temp.max$maxtemp\n    rm(temp.max)\n\n    temp.max<-ddply(abio, \"year\", summarize, maxtemp = mean(avg.daily.max))\n    climate$avg.avg.max.temp<-temp.max$maxtemp\n    rm(temp.max)\n\n#winter min temp\n  #This one could probably be done with less code but i couldn't figure out how\n  janfeb.min <-ddply(abio, \"year\", summarize, min.JF = min(average.daily.min.temp[1:2]))\n  dec.min <-ddply(abio, \"year\", summarize, min.D = min(average.daily.min.temp[12]))\n  \n  year<-1986:2014\n  dec<-dec.min$min.D[1:(30-1)]\n  jf<-janfeb.min$min.JF[2:30]\n  win<-as.data.frame(cbind(year,dec,jf))\n  win$avg.min.temp<-apply(win[,2:3],1,min)\n  win<-win[,c(1,4)]\n  clim.in<-merge(clim.in,win,by.x=\"year\",all.x=T)\n  rm(dec,jf,year,win,janfeb.min,dec.min)\n\n#?growing degree days?\n\n#?Chill units? sept-spring?\n\n#Month of onset of rains - this is hard because in 2013 & 14 rains didnt \"start\" until the following year\n    #brings up question of what constitutes the \"onset\" of rains; also the issue that\n    #means<-aggregate(precip~month,data=abio,FUN=mean)\n    #start<-ddply(abio[abio$precip!=NA,], \"year\", summarize, onset = min(which(month>=7 & month<=12 & precip>30)))\n    #start<-start$month[1:(30-1)]  \n    #start = c(NA, start)\n    #start[15]<-14 #rain for 2013-2014 growing season didn't exceed 30mm until february of 2014\n    #clim.in$rain.start<-start\n    #rm(start)\n  # trying this but with daily data - Levine et al. 2008 fall temp directly after \"major rain event\" (>2.5cm)\n    #to do this must first calculate rain event totals\n      daily<-read.csv(\"/users/Marina/Documents/UCD/Research/Year 1/McLaughlin 80/daily_clim_knox.csv\")\n      daily<-na.omit(daily)\n      daily<-daily[daily$precip<500,] #remove two outliers\n      daily$date<-as.Date(daily$date,\"%m/%d/%y\")\n      newdataframe<-as.data.frame(matrix(0,10420,1))\n      newdataframe$startdate<-daily$date\n      newdataframe$enddate<-daily$date\n      newdataframe<-newdataframe[,-1]\n      numrow = 1 #row number in new data frame\n      precip_total = 0\n      \n      for(i in 1:10420) {\n        \n        if(precip_total == 0 & daily$precip.mm[i] != 0) { # if today starts a new event\n          newdataframe$startdate[numrow] = daily$date[i] # record today as the start date\n        }\n        \n        precip_total = daily$precip.mm[i] + precip_total # add today's rainfall\n        \n        if(daily$precip.mm[i] == 0 & precip_total!=0) { # if today ends an event\n          newdataframe$event_total[numrow] = precip_total # record the total precip\n          newdataframe$enddate[numrow] = daily$date[i-1] # and record yesterday as the last day of the event\n          numrow=numrow+1 # Because this event is over, move to the next event and corresponding row\n          precip_total = 0 # and reset the rainfall total to 0\n        }\n      }\n      newdataframe<-newdataframe[1:774,] #this code spits out nonsense after row number 447 when it catches up to today\n      \n      newdataframe$enddate<-as.Date(newdataframe$enddate,\"%m/%d/%y\")\n      newdataframe$startdate<-as.Date(newdataframe$startdate,\"%m/%d/%y\")\n      newdataframe$month<-as.numeric(format(newdataframe$enddate, \"%m\"))\n      newdataframe$year<-as.numeric(format(newdataframe$enddate, \"%Y\"))\n\n    #I am not entirely sure I need any of this? \n    fall<-merge(newdataframe,daily[,c(1,9)],by.x=\"enddate\",by.y=\"date\")\n    fall<-fall[fall$month>=8 & fall$month<=12,]\n    test<-ddply(fall, \"year\", summarize, avg.temp = avg.temp[event_total>24])\n    test<-merge(test,fall,by=c(\"year\",\"avg.temp\"),all=F)\n    test2<-ddply(test, \"year\", summarize, date = min(enddate))\n    test3<-merge(test[,c(1,2,3,5,6)],test2,by.x=c(\"year\",\"enddate\"),by.y=c(\"year\",\"date\"), all=F)\n    test3<-unique(test3) #two dates had same temp, this fixes duplicate problem\n    test3<-merge(daily[,c(1,3)],test3,by.x=\"date\",by.y=\"enddate\",all.x=F)\n    rm(test,test2,i,numrow,precip_total,fall)\n\n#germination temperature after first rains using average temp of month of first rain\ntest4<-merge(test3[,c(1,3,6)],abio[,c(1,2,4)],by=c(\"year\",\"month\"),all=F)\ncolnames(test4)[4]<-\"germ.temp\"  \nclim.in<-merge(clim.in,test4[,c(1,4)],by=\"year\",all=T)\nrm(test3,test4)\n\n#creating new \"day of growing season\" column \"GROD\"\n  daily<-read.csv(\"/users/Marina/Documents/UCD/Research/Year 1/McLaughlin 80/daily_clim_knox.csv\")\n  daily$date<-as.Date(daily$date,\"%m/%d/%y\")\n  days<-data.frame(date=seq(as.Date(\"1985-01-01\"), as.Date(\"2014-09-10\"), by=\"days\"))\n  days$month<-as.numeric(format(days$date,\"%m\"))\n  days$year<-as.numeric(format(days$date,\"%Y\"))\n  days<-merge(days,daily,by=c(\"date\",\"year\"),all.x=T)\n  test<-ddply(days[days$month>7,],\"year\",transform,grod=1:NROW(date))\n  test2<-ddply(days[days$month<=7,],\"year\",transform,grod=154:c(NROW(date)+153))\n  daily<-rbind(test,test2)\n  rm(test,test2,days)\n\n#start of growing season\n  test<-merge(newdataframe,daily[,c(1,19)],by.x=\"enddate\",by.y=\"date\")  \n  start<-ddply(test,\"year\",summarize, start=min(grod[event_total>25]))\n  start[11,2]<-NA #missing 6 months of data for 1995   \n  start<-c(NA,start$start)\n  start<-start[-31]\n  start[30]<-NA\n  clim.in$start.day<-start\n  rm(start)\n\n#date of cessation of spring rains current year\n  end<-ddply(test,\"year\",summarize, end=max(grod[event_total>25])) \n  end[1,2]<-NA\n  end[29,2]<-149\n  clim.in$end.day<-end$end\n  rm(end,test)\n\n#length of growing season = number of days between starting rains and ending rains \n  clim.in$gro.season<-clim.in$end.day-clim.in$start.day\n\n#length of dry season = 365-gro season\nclim.in$dry.season<-365-clim.in$gro.season\n\n#add in number of rainfall events over a certain amount\nh.events <- ddply(newdataframe, \"year\", summarize, high_events = sum(event_total>25))\nl.events <- ddply(newdataframe, \"year\", summarize, low_events = sum(event_total<25))\nnewdataframe$count<-1\ntest<-aggregate(count ~ year, FUN=sum, data = newdataframe)\ntot_events <- ddply(newdataframe, \"year\", summarize, events = sum(event_total))\nclim.in$high_events<-h.events$high_events\nclim.in$low_events<-l.events$low_events\nclim.in$tot_events<-test$count\nclim.in$rat.hi.lo<-clim.in$high_events/clim.in$low_events\nrm(h.events,l.events,test,tot_events)\n#plot(clim.in$rat.hi.lo~clim.in$year)\n#abline(lm(rat.hi.lo~year,data=clim.in)) \n  \n#Precip - ET --> soil moisture\ndaily<-daily[daily$penman.ET!=-9999,]\ndaily$month<-as.numeric(format(daily$date,\"%m\"))\ntmp<-aggregate(penman.ET~month+year,FUN=sum,data=daily)\nabio<-merge(abio,tmp,by=c(\"year\",\"month\"),all=T)\nrm(tmp)\nabio$moist<-abio$precip-abio$penman.ET\n  #moist in each season\n    ##Fall moist (Sep-Nov) of previous year\n    fall.et<-ddply(abio, \"year\", summarize, et.fall = mean(moist[9:11]))\n    fall.et<-fall.et$et.fall[1:(30-1)]  \n    fall.et = c(NA, fall.et)\n    \n    clim.in$moist.fall<-fall.et\n    rm(fall.et)\n    ##Winter temp (Dec-Feb)\n    dec.et <-ddply(abio, \"year\", summarize, et.dec = mean(moist[12]))\n    janfeb.et <-ddply(abio, \"year\", summarize, et.jf = mean(moist[1:2]))\n    \n    win.et = dec.et$et.dec[1:(30-1)] + janfeb.et$et.jf[2:30]\n    win.et = c(NA, win.et)\n    \n    clim.in$moist.win<-win.et\n    rm(win.et,dec.et,janfeb.et)\n    \n    ##Spring temp (Mar-May)\n    spring<-ddply(abio, \"year\", summarize, et.spr = mean(moist[3:5]))\n    clim.in$moist.spr<-spring$et.spr\n    rm(spring)\n\n    ##Summer temp (Jun-Aug)\n    summer<-ddply(abio, \"year\", summarize, et.sum = mean(moist[6:8]))\n    clim.in$moist.sum<-summer$et.sum\n    rm(summer)\n\n##climate variables from the previous year\n    #Last year precip \n    v<-clim.in$precip.yr\n    v = c(NA, v)\n    v<-v[-31]\n    clim.in$prev.precip<-v\n    rm(v)\n    \n    #previous year fall precip\n    p<-clim.in$precip.fall\n    p = c(NA, p)\n    p<-p[-31]\n    clim.in$prev.precip.f<-p\n    rm(p)\n    \n    #previous year fall temp\n    t<-clim.in$temp.fall\n    t = c(NA, t)\n    t<-t[-31]\n    clim.in$prev.temp.f<-t\n    rm(t)\n    \n    #previous year winter precip\n    pw<-clim.in$precip.win\n    pw = c(NA, pw)\n    pw<-pw[-31]\n    clim.in$prev.precip.w<-pw\n    rm(pw)\n    \n    #previous year winter temp\n    tw<-clim.in$temp.win\n    tw = c(NA, tw)\n    tw<-tw[-31]\n    clim.in$prev.temp.w<-tw\n    rm(tw)\n    \n    #previous year spring precip\n    ps <-clim.in$precip.spr\n    ps = c(NA, ps)\n    ps<-ps[-31]\n    clim.in$prev.precip.s<-ps\n    rm(ps)\n    \n    #previous year spring temp\n    ts<-clim.in$temp.spr\n    ts = c(NA, ts)\n    ts<-ts[-31]\n    clim.in$prev.temp.s<-ts\n    rm(ts)\n    \n    #previous year summer precip\n    ps <-clim.in$precip.sum\n    ps = c(NA, ps)\n    ps<-ps[-31]\n    clim.in$prev.precip.su<-ps\n    rm(ps)\n    \n    #previous year summer temp\n    ts<-clim.in$temp.sum\n    ts = c(NA, ts)\n    ts<-ts[-31]\n    clim.in$prev.temp.su<-ts\n    rm(ts)\n\n    #previous year moist\n      #previous year fall moist\n      p<-clim.in$moist.fall\n      p = c(NA, p)\n      p<-p[-31]\n      clim.in$prev.moist.f<-p\n      rm(p)\n      \n      #previous year winter moist\n      pw<-clim.in$moist.win\n      pw = c(NA, pw)\n      pw<-pw[-31]\n      clim.in$prev.moist.w<-pw\n      rm(pw)\n\n      #previous year spring moist\n      ps <-clim.in$moist.spr\n      ps = c(NA, ps)\n      ps<-ps[-31]\n      clim.in$prev.moist.s<-ps\n      rm(ps)\n      \n      #previous year summer moist\n      ts<-clim.in$moist.sum\n      ts = c(NA, ts)\n      ts<-ts[-31]\n      clim.in$prev.moist.su<-ts\n      rm(ts)\n\n##more shiiiit\nclim.in$var.precip<-clim.in$precip.yr-698.2006\nbarplot(clim.in$var.precip, axes= T, ylim=c(-400,400))\n\n#merge with phenology data from \"Graphs\" R file to create \"Final\" dataframe\n  #grass cover this year (this spilts it out by serp and non-serp)\n    grass.p<-phen[phen$grass.forb!=\"Forb\",]\n    grass.p<-aggregate(Cover~Quadrat+site+Serpentine+Year,FUN=sum,data=grass.p)\n    grass.p<-aggregate(Cover~site+Serpentine+Year,FUN=mean,data=grass.p)\n    grass.p<-aggregate(Cover~Serpentine+Year,FUN=mean,data=grass.p)\n    clim.in<-merge(clim.in,grass.p,by.x=\"year\",by.y=\"Year\")\n    colnames(clim.in)[45]<-\"grass.cover\"\n    gc<-grass.p$Cover\n    gc <- c(rep(NA,12), gc)\n    final$grass.cover<-gc\n    rm(gc)\n    final$grass.cover<-grass.p$Cover\n  #grass cover previous year\n    gc <-final$grass.cover\n    gc = c(rep(NA,14), gc)\n    gc<-gc[-32]\n    gc<-gc[-31]\n    final$prev.grass<-gc\n    rm(gc)\n  #forb freq/cover? previous year\n    fc <-final$freq.Forb.early\n    fc = c(NA, fc)\n    fc<-fc[-31]\n    final$prev.forb.freq<-fc\n    rm(fc)\n   \nwrite.table(climate,\"climate.csv\",sep=\",\",row.names=F)\n\nplot(freq.Forb.early~prev.forb.freq,data=final[final$Serpentine==\"N\" & final$Year>2005,])\nabline(lm(freq.Forb.early~prev.forb.freq,data=final[final$Serpentine==\"N\" & final$Year>2005,]),col=\"red\")\npar(new=T)\nplot(prev.grass~Year,data=final[final$Serpentine==\"N\" & final$Year>2005,],axes=F,xlab=NA,ylab=NA)\nabline(lm(prev.grass~Year,data=final[final$Serpentine==\"N\" & final$Year>2005,]),col=\"blue\")\naxis(side=4)\n#test to see is early forb cover relates to both previous year grass cover \n  plot(Cover.early.Forb~prev.grass,data=na.omit(final[final$Serpentine==\"N\",]))\n  abline(lm(Cover.early.Forb~prev.grass,data=final[final$Serpentine==\"N\" & final$Year>2005,]),col=\"red\")\n\n  plot(Cover.early.Forb~prev.grass,data=na.omit(final[final$Serpentine==\"S\",]))\n  abline(lm(Cover.early.Forb~prev.grass,data=final[final$Serpentine==\"S\" & final$Year>2005,]),col=\"red\")\n\n#early forb in relation to this year\nplot(final$Cover.early.Forb~final$grass.cover,data=na.omit(final[final$Serpentine==\"N\",]))\nabline(lm(final$Cover.early.Forb~final$grass.cover,data=final[final$Serpentine==\"N\" & final$Year>2005,]),col=\"red\")\n\n\nplot(final$tot_events~final$Year)\nabline(lm(final$tot_events~final$Year))\npar(new=T)\nplot(final$precip.yr~final$Year,axes=F,xlab=NA,ylab=NA)\naxis(side=4)\nabline(lm(final$precip.yr~final$Year))\n\nplot(climate$precip.yr/climate$tot_events~climate$year)\nplot(final$precip.yr/final$tot_events~final$Year)\n\nplot(final$Cover.late.Forb[final$Serpentine==\"N\"]~final$freq.Forb.late[final$Serpentine==\"N\"])\nabline(lm(final$Cover.late.Forb[final$Serpentine==\"N\"]~final$temp.spr[final$Serpentine==\"N\"]),col=\"red\")\n",
    "created" : 1436991867321.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "553685202",
    "id" : "A7A28547",
    "lastKnownWriteTime" : 1413490535,
    "path" : "~/Documents/UC-Davis/Research/Year 1/McLaughlin 80/Climate_indices_ddply.R",
    "project_path" : null,
    "properties" : {
    },
    "source_on_save" : false,
    "type" : "r_source"
}